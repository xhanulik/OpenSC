---
name: Linux

on:
  pull_request:
    paths:
      - '**.c'
      - '**.h'
      - '**.sh'
      - .github/workflows/linux.yml
      - '**.am'
      - doc/**
      - configure.ac
  push:

permissions:
  contents: read  #  to fetch code (actions/checkout)


env:
  BASE_DEPS: |
    build-essential docbook-xsl xsltproc gengetopt help2man pcscd check
    pcsc-tools libtool make autoconf autoconf-archive automake pkg-config
    git xxd openssl valgrind socat gawk
    libglib2.0-dev libnss3-dev gnutls-bin libusb-dev libudev-dev flex
    libnss3-tools
    libpcsclite-dev libcmocka-dev libssl-dev zlib1g-dev libreadline-dev softhsm2
  JAVA_DEPS: |
    ant openjdk-8-jdk maven cmake
  JCARDSIM: https://github.com/Jakuje/jcardsim.git
  LIBRESSL_VERSION: 4.0.0
  KRYOPTIC: https://github.com/latchset/kryoptic.git
  KRYOPTIC_DEPS: |
    openssl-devel cargo expect pkgconf-pkg-config gnutls-utils sqlite-devel python3-six which"

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - uses: awalsh128/cache-apt-pkgs-action@v1.4.3
        with:
          packages: ${{ env.BASE_DEPS }}
          version: apt-20-base
          execute_install_scripts: true
      - run: .github/setup-linux.sh
      - run: .github/build.sh dist
      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ubuntu-test-logs
          path: |
            tests/*.log
            src/tests/unittests/*.log
      - uses: actions/cache@v4
        id: cache-build
        with:
          path: ./*
          key: ${{ runner.os }}-${{ github.sha }}
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opensc-build
          path:
            opensc*.tar.gz


  
  #######################
  ## pkcs11-tool tests ##
  #######################

  test-kryoptic:
    runs-on: ubuntu-20.04
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: awalsh128/cache-apt-pkgs-action@v1.4.3
        with:
          packages: ${{ env.BASE_DEPS }} ${{ env.KRYOPTIC }}
          version: apt-20-base
          execute_install_scripts: true
      - uses: actions/cache@v4
        id: cache-build
        with:
          path: ./*
          key: ${{ runner.os }}-${{ github.sha }}
      - run: git clone $KRYOPTIC
      - run: .github/setup-linux.sh kryoptic
      - run: .github/test-kryoptic.sh

